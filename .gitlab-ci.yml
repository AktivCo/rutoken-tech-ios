stages:
  - analyse
  - build
  - test
  - archive
  - export
  - deploy


workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"'
      when: never
    - if: $RUN_ON_BETA == "true"
      variables: 
        TART_IMAGE: $TART_BETA_IMAGE
    - when: always


variables:
  PUBLISH_TO:
    value: "none"
    description: "To whom build should be published, possible values: none, dev, internal"
  SKIP_BUILD:
    value: "false"
    description: "Run only deploy jobs. Values: true/false"
  RUN_ON_BETA:
    value: "false"
    description: "Build and run on image with beta xcode. Values: true/false"

  VAULT_ADDR: "https://vault.aktivco.ru"
  FOLDER_ARTIFACTS: "artifacts"

  TART_IMAGE: tart-hosted.aktivco.ru/rutoken/macos:2.1.0
  TART_BETA_IMAGE: tart-hosted.aktivco.ru/rutoken/macos:15.0b_xcode-16.0b

  MATCH_PASSWORD: ""
  KEYCHAIN_PASSWORD: "admin"
  KEY_ID: ""
  ISSUER_ID: ""
  API_KEY: "/tmp/api_key.p8"
  FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120


include:
  - project: rutoken/dev/devops/checker/code-quality
    ref: latest
    file: /code-quality.yaml
  - .ci/stage-*.yml


code-quality:
  stage: analyse
  extends: .code-quality
